{{define "jobs-cards"}}
{{range .Jobs}}
<div class="job-card" 
     data-job-id="{{.ID}}"
     data-job-status="{{.LastStatus}}"
     data-next-run="{{.NextRun.Unix}}">
    
    <!-- Status indicator -->
    <div class="job-status status-{{.LastStatus}}">
        {{if .IsRunning}}
        <div class="status-indicator running">
            <div class="pulse"></div>
        </div>
        {{else if eq .LastStatus.String "success"}}
        <div class="status-indicator success">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        {{else if eq .LastStatus.String "failed"}}
        <div class="status-indicator failed">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>
        {{else}}
        <div class="status-indicator idle"></div>
        {{end}}
    </div>
    
    <!-- Schedule and command -->
    <div class="job-header">
        <div class="job-schedule" title="{{.Schedule}}">
            <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <code>{{.Schedule}}</code>
        </div>
        <div></div><!-- Spacer for grid -->
        <div class="job-header-actions">
            <button class="history-btn"
                    {{if eq .LastStatus.String "idle"}}
                    disabled
                    title="No execution history"
                    {{else}}
                    hx-get="/api/jobs/{{.ID}}/history"
                    hx-target="#history-content"
                    hx-swap="innerHTML"
                    hx-on::after-request="document.getElementById('history-modal').style.display='flex'"
                    title="Show execution history"
                    {{end}}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="btn-compact"
                    {{if and .Enabled (not .IsRunning)}}
                    hx-post="/api/jobs/{{.ID}}/run"
                    hx-swap="none"
                    hx-confirm='{{.Command}}'
                    hx-on::after-request="this.disabled=true; setTimeout(() => this.disabled=false, 2000)"
                    {{else}}
                    disabled
                    {{end}}>
                <svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none">
                    <path d="M5 3l14 9-14 9V3z" fill="currentColor"/>
                </svg>
                <span>Run</span>
            </button>
        </div>
    </div>
    
    <div class="job-command">
        <button class="info-btn"
                hx-get="/api/jobs/{{.ID}}/modal"
                hx-target="#modal-content"
                hx-swap="innerHTML"
                hx-on::after-request="document.getElementById('job-modal').style.display='flex'"
                title="Show job details">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
        <code title="{{.Command}}">{{truncate .Command 60}}</code>
    </div>
    
    <!-- Timing info -->
    <div class="job-timing">
        <div class="timing-item">
            <span class="timing-label">Next run:</span>
            <span class="timing-value" title="{{.NextRun.Format "2006-01-02 15:04:05"}}">
                {{timeUntil .NextRun}}{{if not .NextRun.IsZero}} ({{.NextRun.Format "Jan 2, 15:04"}}){{end}}
            </span>
        </div>
        <div class="timing-item">
            <span class="timing-label">Last run:</span>
            <span class="timing-value">{{if .LastRun.IsZero}}Never{{else}}{{humanTime .LastRun}}{{end}}</span>
        </div>
    </div>
    
</div>
{{end}}
{{end}}

{{define "jobs-list"}}
<table class="jobs-table">
    <thead>
        <tr>
            <th class="th-status">Status</th>
            <th class="th-schedule cron">Schedule</th>
            <th class="th-command">Command</th>
            <th class="th-next numeric">Next Run</th>
            <th class="th-last numeric">Last Run</th>
            <th class="th-actions">Actions</th>
        </tr>
    </thead>
    <tbody>
        {{range .Jobs}}
        <tr class="job-row" 
            data-job-id="{{.ID}}"
            data-job-status="{{.LastStatus}}"
            data-next-run="{{.NextRun.Unix}}">
            
            <td class="td-status">
                {{if .IsRunning}}
                <div class="status-badge running">
                    <div class="status-dot"></div>
                    Running
                </div>
                {{else if eq .LastStatus.String "success"}}
                <div class="status-badge success">
                    <div class="status-dot"></div>
                    Success
                </div>
                {{else if eq .LastStatus.String "failed"}}
                <div class="status-badge failed">
                    <div class="status-dot"></div>
                    Failed
                </div>
                {{else}}
                <div class="status-badge idle">
                    <div class="status-dot"></div>
                    Idle
                </div>
                {{end}}
            </td>
            
            <td class="td-schedule">
                <code class="schedule-code">{{.Schedule}}</code>
            </td>
            
            <td class="td-command command">
                <button class="info-btn"
                        hx-get="/api/jobs/{{.ID}}/modal"
                        hx-target="#modal-content"
                        hx-swap="innerHTML"
                        hx-on::after-request="document.getElementById('job-modal').style.display='flex'"
                        title="Show job details">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <code class="command-text" title="{{.Command}}">{{truncate .Command 80}}</code>
            </td>
            
            <td class="td-next numeric">
                <span class="time-value" title="{{.NextRun.Format "2006-01-02 15:04:05"}}">
                    {{timeUntil .NextRun}}{{if not .NextRun.IsZero}} ({{.NextRun.Format "Jan 2, 15:04"}}){{end}}
                </span>
            </td>
            
            <td class="td-last numeric">
                <span class="time-value">{{if .LastRun.IsZero}}Never{{else}}{{humanTime .LastRun}}{{end}}</span>
            </td>
            
            <td class="td-actions">
                <button class="history-btn"
                        {{if eq .LastStatus.String "idle"}}
                        disabled
                        title="No execution history"
                        {{else}}
                        hx-get="/api/jobs/{{.ID}}/history"
                        hx-target="#history-content"
                        hx-swap="innerHTML"
                        hx-on::after-request="document.getElementById('history-modal').style.display='flex'"
                        title="Show execution history"
                        {{end}}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <button class="btn-compact"
                        {{if and .Enabled (not .IsRunning)}}
                        hx-post="/api/jobs/{{.ID}}/run"
                        hx-swap="none"
                        hx-confirm='{{.Command}}'
                        hx-on::after-request="this.disabled=true; setTimeout(() => this.disabled=false, 2000)"
                        {{else}}
                        disabled
                        {{end}}>
                    <svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none">
                        <path d="M5 3l14 9-14 9V3z" fill="currentColor"/>
                    </svg>
                    <span>Run</span>
                </button>
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
{{end}}

{{define "filter-button"}}
<button {{if .IsOOB}}hx-swap-oob="outerHTML:.filter-button"{{end}}
        hx-post="/api/filter-toggle"
        hx-target="#jobs-container"
        hx-swap="innerHTML"
        hx-vals="js:{search: document.querySelector('[name=search]')?.value || ''}"
        class="filter-button"
        title="Filter by status">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="filter-icon">
        <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span class="filter-label" id="filter-label">
        {{if eq .FilterMode.String "all"}}All Jobs{{else if eq .FilterMode.String "running"}}Running{{else if eq .FilterMode.String "success"}}Success{{else}}Failed{{end}}
    </span>
    {{if ne .FilterMode.String "all"}}
    <span class="filter-indicator {{.FilterMode.String}}"></span>
    {{end}}
</button>
{{end}}

{{define "sort-button"}}
<button {{if .IsOOB}}hx-swap-oob="outerHTML:.sort-button"{{end}}
        hx-post="/api/sort-toggle"
        hx-target="#jobs-container"
        hx-swap="innerHTML"
        hx-vals="js:{search: document.querySelector('[name=search]')?.value || ''}"
        class="sort-button"
        title="Change sort order">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="sort-icon">
        <path d="M3 6h18M3 12h12M3 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="sort-label" id="sort-label">
        {{if eq .SortMode.String "default"}}Original Order{{else if eq .SortMode.String "lastrun"}}Last Run{{else}}Next Run{{end}}
    </span>
</button>
{{end}}

{{define "jobs-container"}}
<div id="jobs-container"
     hx-get="/api/jobs"
     hx-trigger="load, every 5s"
     hx-swap="innerHTML settle:0ms"
     hx-include="[name='search']"
     class="jobs-container {{.ViewMode}}">
{{if eq .ViewMode.String "cards"}}
    {{template "jobs-cards" .}}
{{else}}
    {{template "jobs-list" .}}
{{end}}
</div>
{{end}}

{{define "view-mode-button"}}
<button hx-post="/api/view-mode"
        hx-trigger="click"
        hx-target="#jobs-container"
        hx-swap="outerHTML"
        hx-vals="js:{search: document.querySelector('[name=search]')?.value || ''}"
        {{if .IsOOB}}hx-swap-oob="outerHTML:.view-toggle"{{end}}
        class="control-btn view-toggle"
        title="Toggle view mode">
    {{if eq .ViewMode.String "cards"}}
    <!-- List icon (switch to list) -->
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line x1="8" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="8" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="4" cy="6" r="1" fill="currentColor"/>
        <circle cx="4" cy="12" r="1" fill="currentColor"/>
        <circle cx="4" cy="18" r="1" fill="currentColor"/>
    </svg>
    {{else}}
    <!-- Card icon (switch to cards) -->
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
        <rect x="13" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
        <rect x="3" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
        <rect x="13" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
    </svg>
    {{end}}
</button>
{{end}}

{{define "stats-updates"}}
{{if .IsOOB}}
<span id="running-count" hx-swap-oob="innerHTML">{{.RunningCount}}</span>
<span id="next-run" hx-swap-oob="innerHTML">{{.NextRunTime}}</span>
<span id="total-count" hx-swap-oob="innerHTML">{{.TotalCount}}</span>
{{end}}
{{end}}

{{define "job-modal"}}
<div class="job-modal">
    <div class="modal-header">
        <h2>Job Details</h2>
        <button class="modal-close" onclick="document.getElementById('job-modal').style.display='none'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    </div>

    <div class="modal-body">
        <div class="modal-row">
            <div class="modal-section">
                <div class="modal-label">Status</div>
                <div class="modal-value">
                    {{if .IsRunning}}
                    <div class="status-badge running">
                        <div class="status-dot"></div>
                        Running
                    </div>
                    {{else if eq .LastStatus.String "success"}}
                    <div class="status-badge success">
                        <div class="status-dot"></div>
                        Success
                    </div>
                    {{else if eq .LastStatus.String "failed"}}
                    <div class="status-badge failed">
                        <div class="status-dot"></div>
                        Failed
                    </div>
                    {{else}}
                    <div class="status-badge idle">
                        <div class="status-dot"></div>
                        Idle
                    </div>
                    {{end}}
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-label">Schedule</div>
                <div class="modal-value">
                    <code>{{.Schedule}}</code>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-label">Enabled</div>
                <div class="modal-value">
                    {{if .Enabled}}Yes{{else}}No{{end}}
                </div>
            </div>
        </div>

        <div class="modal-row">
            <div class="modal-section">
                <div class="modal-label">Next Run</div>
                <div class="modal-value">
                    {{if .NextRun.IsZero}}
                    Never
                    {{else}}
                    {{.NextRun.Format "2006-01-02 15:04:05"}} ({{timeUntil .NextRun}})
                    {{end}}
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-label">Last Run</div>
                <div class="modal-value">
                    {{if .LastRun.IsZero}}
                    Never
                    {{else}}
                    {{.LastRun.Format "2006-01-02 15:04:05"}} ({{humanTime .LastRun}})
                    {{end}}
                </div>
            </div>
        </div>

        <div class="modal-section modal-section-full">
            <div class="modal-label">Command</div>
            <div class="modal-value modal-command">
                <code>{{.Command}}</code>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "history-modal"}}
<div class="history-modal">
    <div class="modal-header">
        <h2>Execution History</h2>
        <button class="modal-close" onclick="document.getElementById('history-modal').style.display='none'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    </div>

    <div class="modal-body">
        <div class="modal-section modal-section-full">
            <div class="modal-label">Command</div>
            <div class="modal-value modal-command">
                <code class="history-command" data-base-command="{{.Job.Command}}">{{.Job.Command}}</code>
            </div>
        </div>

        {{if .Executions}}
        <div class="history-table-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th style="width: 30px;"></th>
                        <th>Started</th>
                        <th>Finished</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Executions}}
                    <tr {{if .ExecutedCommand}}
                        class="history-row-clickable"
                        data-base-command="{{$.Job.Command}}"
                        data-executed-command="{{.ExecutedCommand}}"
                        onclick="toggleHistoryCommand(this)"
                        title="Click to view executed command"
                        {{end}}>
                        <td class="history-icon-cell">
                            {{if .ExecutedCommand}}
                            <svg class="history-custom-icon" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
                            </svg>
                            {{end}}
                        </td>
                        <td class="history-date">{{.StartedAt.Format "Jan 2, 15:04:05"}}</td>
                        <td class="history-date">
                            {{if .FinishedAt.IsZero}}
                            -
                            {{else}}
                            {{.FinishedAt.Format "Jan 2, 15:04:05"}}
                            {{end}}
                        </td>
                        <td class="history-duration">
                            {{if or (.StartedAt.IsZero) (.FinishedAt.IsZero)}}
                            -
                            {{else}}
                            {{humanDuration (.FinishedAt.Sub .StartedAt)}}
                            {{end}}
                        </td>
                        <td>
                            {{if eq .Status.String "success"}}
                            <div class="status-badge success">
                                <div class="status-dot"></div>
                                Success
                            </div>
                            {{else}}
                            <div class="status-badge failed">
                                <div class="status-dot"></div>
                                Failed
                            </div>
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="history-empty">
            <p>No execution history available</p>
        </div>
        {{end}}
    </div>
</div>
{{end}}